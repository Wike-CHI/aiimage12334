# 生图V2 多分辨率(2K/4K) 支持实现方案

## 1. 背景
目前生图V2接口 (`/api/v2/process`) 和前端 UI 均已定义了 `image_size` 参数 (1K, 2K, 4K) 和 `aspect_ratio` 参数，但在后端服务层 `process_image_with_gemini` 中，这些参数仅被记录日志，未实际用于控制输出图片的尺寸。默认情况下，Gemini API 返回的图片尺寸可能不固定或仅为默认分辨率。

## 2. 目标
完善后端逻辑，确保生成的图片严格符合用户选择的分辨率和宽高比。

## 3. 技术方案

### 3.1 分辨率定义
基于基准短边/长边定义不同档位的像素尺寸：

| 规格 | 基准尺寸 (1:1) | 备注 |
| :--- | :--- | :--- |
| **1K** | 1024 x 1024 | 默认标准 |
| **2K** | 2048 x 2048 | 高清 |
| **4K** | 4096 x 4096 | 超高清 |

对于非 1:1 的宽高比，将基于像素总数或长边进行适配。例如 2K 下的 3:4 比例，宽约为 1536，高约为 2048。

### 3.2 实现逻辑
在 `backend/app/services/image_gen_v2.py` 中修改 `process_image_with_gemini` 函数：

1.  **解析目标尺寸**：
    新增一个辅助函数 `calculate_target_size(aspect_ratio: str, image_size: str) -> Tuple[int, int]`，根据传入的比例和档位计算具体的 `(width, height)`。

2.  **图片后处理 (Resizing)**：
    由于 Gemini API 目前 (preview版) 可能无法通过参数强制指定精确的像素输出（通常返回 1024x1024 或自适应比例），我们需要在获取到 API 生成的图片后，使用 `PIL` (Pillow) 进行高质量调整。
    *   **策略**：`LANCZOS` 重采样算法（保证缩放质量）。
    *   **流程**：
        1.  API 生成图片 (通常为 1024x1024)。
        2.  读取生成的图片。
        3.  调用 `calculate_target_size` 获取目标尺寸。
        4.  如果生成尺寸与目标尺寸不符，使用 `image.resize(target_size, Image.Resampling.LANCZOS)` 进行调整。
        5.  保存调整后的图片。

### 3.3 代码变更点
*   **文件**: `backend/app/services/image_gen_v2.py`
*   **新增函数**: `calculate_target_size`
*   **修改函数**: `process_image_with_gemini` (在保存图片前增加 resize 逻辑)

### 3.4 宽高比映射表 (参考)
| 比例 | 1K (WxH) | 2K (WxH) | 4K (WxH) |
| :--- | :--- | :--- | :--- |
| 1:1 | 1024x1024 | 2048x2048 | 4096x4096 |
| 3:4 | 768x1024 | 1536x2048 | 3072x4096 |
| 4:3 | 1024x768 | 2048x1536 | 4096x3072 |
| 9:16 | 576x1024 | 1152x2048 | 2304x4096 |
| 16:9 | 1024x576 | 2048x1152 | 4096x2304 |
*(注：具体数值将通过算法动态计算，保持长边对齐相应档位)*

## 4. 验证计划
1.  **单元测试**: 测试 `calculate_target_size` 对不同输入的计算是否正确。
2.  **集成测试**: 调用 V2 接口，请求 2K/4K 图片，检查输出文件的实际物理分辨率。
