# V2同步接口测试文档

## 测试信息

- **测试日期**: 2025-12-28
- **测试图片**: 微信图片_20251227205807_94_111.jpg
- **后端地址**: http://localhost:8001
- **API代理**: http://localhost:8888/gemini

## 测试范围

| 模块 | 测试项 | 状态 | 说明 |
|------|--------|------|------|
| 前端API客户端 | generationV2API.process | 待测试 | 上传并处理图片 |
| 前端API客户端 | generationV2API.getTemplates | 待测试 | 获取模板列表 |
| 前端API客户端 | generationV2API.getChains | 待测试 | 获取模板链 |
| 后端路由 | POST /api/v2/process/upload | 待测试 | 同步处理接口 |
| 后端路由 | GET /api/v2/templates | 待测试 | 模板列表接口 |
| 完整流程 | 上传图片 -> 处理 -> 返回结果 | 待测试 | 端到端测试 |

## 测试步骤

### 1. 启动服务

```bash
# 启动后端服务
cd /www/wwwroot/生图网站/aiimage12334/backend
source .venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8001

# 确保API代理服务运行 (端口8888)
```

### 2. 手动API测试

#### 2.1 测试模板列表接口

```bash
curl -X GET "http://localhost:8001/api/v2/templates" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

预期响应:
```json
[
  {
    "template_id": "remove_bg",
    "name": "背景去除",
    "category": "remove_bg",
    "description": "去除图片背景，保留产品主体",
    "priority": 1,
    "enabled": true
  },
  ...
]
```

#### 2.2 测试模板链接口

```bash
curl -X GET "http://localhost:8001/api/v2/chains" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

预期响应:
```json
[
  {
    "chain_id": "default",
    "name": "默认白底图处理链",
    "template_count": 4,
    "template_ids": ["remove_bg", "standardize", "ecommerce", "color_correct"]
  }
]
```

#### 2.3 测试同步处理接口

```bash
curl -X POST "http://localhost:8001/api/v2/process/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@微信图片_20251227205807_94_111.jpg" \
  -F "template_ids[0]=remove_bg" \
  -F "template_ids[1]=standardize" \
  -F "template_ids[2]=ecommerce" \
  -F "template_ids[3]=color_correct"
```

预期响应:
```json
{
  "success": true,
  "result_path": "results/xxx_result.png",
  "elapsed_time": 45.2,
  "used_templates": ["remove_bg", "standardize", "ecommerce", "color_correct"]
}
```

### 3. Python测试脚本

创建测试脚本:

```python
"""
V2接口端到端测试脚本
"""
import os
import sys
import time
import base64

# 添加后端路径
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

from app.services.prompt_template import get_prompt_manager
from app.services.image_gen_v2 import process_image_with_gemini
from app.config import get_settings

def test_v2_integration():
    """测试V2完整集成"""
    print("=" * 60)
    print("V2接口集成测试")
    print("=" * 60)
    
    # 1. 测试模板管理器
    print("\n[1] 测试模板管理器")
    manager = get_prompt_manager()
    templates = manager.list_templates()
    print(f"  - 可用模板数量: {len(templates)}")
    for t in templates:
        print(f"    - [{t.category.value}] {t.name}")
    chains = manager.list_chains()
    print(f"  - 可用模板链数量: {len(chains)}")
    for c in chains:
        print(f"    - {c['name']}: {c['template_ids']}")
    print("  [通过] 模板管理器正常")
    
    # 2. 测试提示词构建
    print("\n[2] 测试提示词构建")
    template_ids = ["remove_bg", "standardize", "ecommerce", "color_correct"]
    prompt = manager.build_prompt_from_chain(template_ids, product_category="服装")
    print(f"  - 提示词长度: {len(prompt)} 字符")
    print(f"  - 模板数量: {len(template_ids)}")
    print("  [通过] 提示词构建正常")
    
    # 3. 测试图片处理（如果有测试图片）
    test_image = "微信图片_20251227205807_94_111.jpg"
    output_path = f"results/v2_test_result.png"
    
    if os.path.exists(test_image):
        print(f"\n[3] 测试图片处理: {test_image}")
        
        if not os.path.exists("results"):
            os.makedirs("results")
        
        start_time = time.time()
        try:
            result = process_image_with_gemini(
                image_path=test_image,
                output_path=output_path,
                template_ids=template_ids,
                timeout_seconds=300
            )
            elapsed = time.time() - start_time
            
            print(f"  - 处理结果: {'成功' if result['success'] else '失败'}")
            print(f"  - 耗时: {elapsed:.2f} 秒")
            print(f"  - API返回耗时: {result.get('elapsed_time', 'N/A')} 秒")
            print(f"  - 结果路径: {result.get('result_path', 'N/A')}")
            print(f"  - 使用模板: {result.get('used_templates', [])}")
            
            if result['success']:
                print("  [通过] 图片处理成功")
            else:
                print(f"  [失败] {result.get('error_message', '未知错误')}")
                
        except Exception as e:
            print(f"  [失败] 处理异常: {str(e)}")
    else:
        print(f"\n[3] 跳过图片处理测试")
        print(f"  - 测试图片不存在: {test_image}")
    
    print("\n" + "=" * 60)
    print("测试完成")
    print("=" * 60)

if __name__ == "__main__":
    test_v2_integration()
```

### 4. 前端测试检查清单

#### 4.1 API客户端检查

```typescript
// 在浏览器控制台执行
import { generationV2API } from '@/integrations/api/client';

// 测试1: 获取模板列表
console.log('测试模板列表...');
generationV2API.getTemplates()
  .then(res => console.log('模板数量:', res.data?.length))
  .catch(err => console.error('失败:', err));

// 测试2: 获取模板链
console.log('测试模板链...');
generationV2API.getChains()
  .then(res => console.log('链数量:', res.data?.length))
  .catch(err => console.error('失败:', err));
```

#### 4.2 页面功能检查

- [ ] 打开首页 http://localhost:5173
- [ ] 登录账号
- [ ] 上传测试图片
- [ ] 点击"生成白底图"按钮
- [ ] 观察是否显示"处理中..."状态
- [ ] 等待处理完成（预计1-3分钟）
- [ ] 检查是否显示处理耗时
- [ ] 验证白底图是否正确生成
- [ ] 测试下载功能

## 预期性能指标

| 指标 | 预期值 | 说明 |
|------|--------|------|
| API响应时间 | 1-3分钟 | 4K图片处理 |
| 前端无轮询 | 是 | 直接等待结果 |
| 积分扣除 | 1积分 | 处理完成后 |
| 错误处理 | 提示具体信息 | 失败时显示原因 |

## 常见问题排查

### 问题1: API返回401未授权
**解决**: 检查token是否有效，重新登录获取token

### 问题2: 处理超时
**解决**: 
- 检查API代理服务是否正常运行
- 检查Gemini API配额
- 尝试减小图片尺寸

### 问题3: 返回空结果
**解决**: 
- 检查后端日志
- 确认模板ID正确
- 检查图片格式是否支持

### 问题4: 积分未扣除
**解决**: 刷新页面，积分会在下次API调用时同步

## 测试结果记录

| 测试项 | 执行人 | 执行时间 | 结果 | 备注 |
|--------|--------|----------|------|------|
| 模板列表API | | | | |
| 模板链API | | | | |
| 同步处理API | | | | |
| 端到端流程 | | | | |

## 总结

V2同步接口相比V1的优势:
1. **无需轮询**: 直接等待API返回结果
2. **实时反馈**: 显示处理进度和耗时
3. **简化流程**: 减少状态管理的复杂度
4. **更好的用户体验**: 明确的等待时间预期

---

**测试文档版本**: v1.0
**最后更新**: 2025-12-28

