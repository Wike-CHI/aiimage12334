# 后端启动脚本使用说明

本文档详细介绍了 Windows 环境下后端启动脚本 `scripts/start_backend.bat` 的功能、使用方法及故障排除指南。

## 1. 脚本简介

该脚本专为 Windows 开发环境设计，旨在解决常见的后端启动问题，提供一键式启动体验。

**核心功能：**
*   **智能环境检测**：自动查找并激活 `.venv`, `.venv312`, `venv` 等常见虚拟环境。
*   **端口冲突自动处理**：
    *   自动检测默认端口 `8000` 是否被占用。
    *   尝试自动终止占用端口的进程。
    *   **备用端口切换**：如果无法终止进程（如权限不足），脚本会自动切换到下一个可用端口（如 `8001`），确保服务能顺利启动。
*   **健壮的错误处理**：对关键步骤进行错误检查，并提供清晰的日志输出。
*   **中文支持**：强制使用 UTF-8 编码，避免中文乱码。

## 2. 使用方法

### 方式一：通过 npm (推荐)

在项目根目录下运行：

```bash
npm run dev:backend
```

### 方式二：直接运行脚本

在命令行中直接执行：

```cmd
scripts\start_backend.bat
```

或者在资源管理器中双击该文件。

## 3. 详细流程说明

1.  **初始化**：设置 UTF-8 编码，定义日志格式。
2.  **虚拟环境检查**：
    *   按顺序检查 `.venv312`, `.venv`, `venv`, `env` 目录。
    *   如果找到 `Scripts\activate.bat`，则自动激活。
    *   如果未找到，将尝试使用系统全局的 `python` 命令，并给出警告。
3.  **端口处理**：
    *   检查端口 `8000`。
    *   **如果端口被占用**：
        *   输出占用该端口的 PID。
        *   尝试使用 `taskkill /F /PID <PID>` 强制终止进程。
        *   **如果终止失败**（例如进程属于其他用户或系统服务）：
            *   输出错误日志。
            *   自动尝试下一个端口（`8001`）。
            *   重复此过程直到找到可用端口。
4.  **启动服务**：
    *   进入 `backend` 目录。
    *   运行 `uvicorn app.main:app --host 0.0.0.0 --port <PORT> --reload`。

## 4. 注意事项

*   **端口变化**：如果脚本切换了端口（例如从 `8000` 切换到 `8001`），会在控制台输出 `[ATTENTION]` 警告。此时请注意前端应用可能无法连接到后端，您可能需要更新前端的 `.env` 文件或代理配置。
*   **权限问题**：如果脚本提示无法终止进程，您可以尝试以**管理员身份**运行终端或脚本。

## 5. 故障排除

**Q: 脚本提示 "'python' is not recognized..."**
A: 请确保您已安装 Python 并将其添加到了系统 PATH 环境变量中，或者在项目根目录下创建了虚拟环境。

**Q: 启动后前端无法连接后端**
A: 检查脚本输出的端口号。如果端口不是 `8000`，请检查前端配置。

**Q: 中文显示乱码**
A: 脚本已内置 `chcp 65001`。如果仍有乱码，请检查您的终端字体设置（推荐使用 Consolas 或 Cascadia Code）。
